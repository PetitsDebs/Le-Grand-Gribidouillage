<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Admin — Le Grand Gribidouillage</title>
  <style>
    :root{ --pad:16px; --gap:12px; --card:#fff; --ink:#111; --muted:#666; --bd:#ddd; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; background:#f6f7f9; color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header{ padding: var(--pad); border-bottom:1px solid var(--bd); background:#fff; position:sticky; top:0; z-index:20; }
    h1{ margin:0; font-size:20px; }
    .wrap{ padding: var(--pad); }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:12px; padding: var(--pad); }
    .row{ display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }
    .grid{ display:grid; gap: var(--gap); }
    .grid.cols2{ grid-template-columns: 1.1fr 1fr; align-items:start; }
    label.inline{ display:flex; gap:8px; align-items:center; }
    .muted{ color: var(--muted); }
    button{ padding:8px 12px; border-radius:10px; border:1px solid #bbb; background:#fff; cursor:pointer; font-weight:600; }
    button[disabled]{ opacity:.5; cursor:not-allowed; }
    input[type="password"], input[type="text"], input[type="search"], select{ padding:8px 10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
    .kpi{ display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); }
    .kpi .item{ padding:14px; border:1px solid var(--bd); border-radius:12px; background:#fff; }
    .kpi .n{ font-size:22px; font-weight:800; }
    canvas{ image-rendering: pixelated; border:1px solid #333; background:#fff; }

    /* Tabs */
    .tabs{ display:flex; gap:8px; border-bottom:1px solid var(--bd); margin-bottom:12px; }
    .tab{ padding:8px 12px; border:1px solid var(--bd); border-bottom:none; border-radius:10px 10px 0 0; background:#fafafa; cursor:pointer; }
    .tab.active{ background:#fff; font-weight:700; }
    .tab.hidden{ display:none; }
    .tabpanes > .pane{ display:none; }
    .tabpanes > .pane.active{ display:block; }

    .danger{ color:#b00020; border-color:#b00020; }
    .ok{ color:#0a7a20; }
    .note{ font-size:12px; }
    .footer{ padding: var(--pad); text-align:center; color:var(--muted); }

    table{ width:100%; border-collapse: collapse; }
    th, td{ text-align:left; padding:8px 10px; border-bottom:1px solid var(--bd); font-size:14px; }
    th{ background:#fafafa; position:sticky; top:0; z-index:10; }
    .tablewrap{ max-height: 60vh; overflow:auto; border:1px solid var(--bd); border-radius:10px; background:#fff; }
    .right{ text-align:right; }

    /* Chart */
    .charthead{ display:flex; align-items:center; gap:8px; }
    .daynav{ display:flex; align-items:center; gap:4px; }
    .daynav button{ width:32px; height:28px; font-weight:700; }
    #chartWrap{ position:relative; width:100%; max-width:680px; }
    #chartNoData{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.85); font-size:14px; }

    /* Gestion */
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; background:#fff; }
    .badge.online{ color:#0a7; border-color:#7bd; background:#f0fffb; }
    .badge.banned{ color:#b00020; border-color:#e7a3a8; background:#fff5f6; }
    .uid{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; opacity:.85; }
    .row-actions{ display:flex; gap:8px; }
    .row.sel{ background:#f2f6ff; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Admin — Le Grand Gribidouillage</h1>
      <span class="muted">• contrôle & maintenance</span>
    </div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="dash">Tableau de bord</div>
      <div class="tab" data-tab="stats">Statistiques</div>
      <div class="tab hidden" data-tab="gestion" id="tab-gestion">Gestion</div>
    </div>
  </header>

  <div class="wrap">
    <div class="tabpanes">
      <!-- ====== PANE: DASHBOARD ====== -->
      <section id="pane-dash" class="pane active">
        <div class="grid cols2">
          <!-- Colonne A -->
          <section class="grid">
            <div class="card">
              <h2 style="margin-top:0">Accès admin</h2>
              <p class="muted">Saisis le <strong>code admin</strong> défini dans <code>config/adminCode</code> (Realtime DB).</p>
              <div class="row">
                <input id="adminCodeInput" type="password" placeholder="••••••••" />
                <button id="adminCodeCheck">Déverrouiller</button>
                <span id="adminGateStatus" class="muted">verrouillé</span>
              </div>
              <p class="note">Tant que non déverrouillé, les actions critiques restent désactivées.</p>
            </div>

            <div class="card">
              <h2 style="margin-top:0">Stats</h2>
              <div class="kpi">
                <div class="item">
                  <div class="muted">Connectés</div>
                  <div id="kOnline" class="n">—</div>
                </div>
                <div class="item">
                  <div class="muted">Pixels posés</div>
                  <div id="kPixels" class="n">—</div>
                </div>
                <div class="item">
                  <div class="muted">Clics total</div>
                  <div id="kClicks" class="n">—</div>
                </div>
              </div>
              <div class="row" style="margin-top:12px">
                <div class="muted">Dernier reset :</div>
                <div id="lastReset">—</div>
              </div>
            </div>

            <div class="card">
              <h2 style="margin-top:0">Aperçu mosaïque</h2>
              <div class="row">
                <canvas id="preview" width="300" height="300"></canvas>
                <div class="grid" style="align-content:start">
                  <button id="btnRefreshPreview">Rafraîchir</button>
                  <button id="btnExportPNG">Exporter PNG</button>
                  <button id="btnArchivePNG" disabled>Archiver vers Storage</button>
                  <span class="note">Export 1200×1200, rendu net (x4).</span>
                </div>
              </div>
            </div>
          </section>

          <!-- Colonne B -->
          <section class="grid">
            <div class="card">
              <h2 style="margin-top:0">Actions</h2>
              <div class="grid">
                <div>
                  <div class="muted">Purge complète (efface <code>pixels/</code> & écrit <code>config/lastResetAt</code>)</div>
                  <div class="row" style="margin-top:8px">
                    <input id="confirmClear" type="text" placeholder='Tape "CLEAR" pour confirmer' />
                    <button id="btnClear" class="danger" disabled>Vider la mosaïque</button>
                  </div>
                  <p class="note">⚠️ Irréversible. Sauvegarde/Archive avant !</p>
                </div>
              </div>
            </div>

            <!-- Infos système masquée tant que l’admin n’est pas validé -->
            <div class="card" id="sysInfoCard" style="display:none">
              <h2 style="margin-top:0">Infos système</h2>
              <ul class="note">
                <li>SDK: Firebase compat 10.12.2</li>
                <li>DB: <code>pixels/{x}_{y} → { color:number, author?:uid, ts?:number }</code></li>
                <li>Historique: <code>history/{x}_{y}/{pushId} → { color, author, ts }</code></li>
                <li>Fréquentation: <code>stats/onlineByHour/YYYY-MM-DD/{HH}</code></li>
                <li>Archive Storage: <code>archive/</code></li>
              </ul>
              <div id="sysStatus" class="muted">Prêt.</div>
            </div>
          </section>
        </div>
      </section>

      <!-- ====== PANE: STATISTIQUES ====== -->
      <section id="pane-stats" class="pane">
        <div class="grid cols2">
          <!-- Colonne A : Hit parade -->
          <section class="grid">
            <div class="card">
              <h2 style="margin:0 0 8px 0">Hit parade (temps réel)</h2>
              <p class="note" style="margin-top:0">Classement par nombre de pixels actuellement détenus sur la mosaïque. <em>(UIDs sans pseudo exclus)</em></p>
              <div class="tablewrap">
                <table>
                  <thead>
                    <tr>
                      <th class="right">#</th>
                      <th>Pseudo</th>
                      <th class="right">Pixels</th>
                      <th class="right">%</th>
                    </tr>
                  </thead>
                  <tbody id="leaderBody"></tbody>
                </table>
              </div>
              <p class="note">Top 20, mise à jour automatique.</p>
            </div>
          </section>

          <!-- Colonne B : Fréquentation + Historique -->
          <section class="grid">
            <div class="card">
              <div class="row" style="justify-content:space-between; align-items:center">
               <h2 style="margin:0">Connexions par minute</h2>
                <div class="daynav">
                  <button id="dayPrev" title="Jour précédent">⟨</button>
                  <span id="dayLabel" class="muted">—</span>
                  <button id="dayNext" title="Jour suivant">⟩</button>
                </div>
              </div>
              <div id="chartWrap" style="margin-top:8px">
                <canvas id="chart" width="680" height="240"></canvas>
                <div id="chartNoData">Aucune donnée pour ce jour</div>
              </div>
             <p class="note" style="margin-top:8px">Source: <code>stats/visitsByMinute/YYYY-MM-DD/HH:mm</code>.Ligne = visites/minute (chargements de la mosaïque).</p>
            </div>

            <div class="card">
              <div class="row" style="justify-content:space-between">
                <h2 style="margin:0">Historique des poses</h2>
                <div class="row">
                  <label class="inline">
                    Limite:
                    <select id="histLimit">
                      <option value="100">100</option>
                      <option value="200" selected>200</option>
                      <option value="300">300</option>
                      <option value="500">500</option>
                    </select>
                  </label>
                  <button id="btnReloadHistory">Rafraîchir</button>
                </div>
              </div>
              <div class="tablewrap" style="margin-top:12px">
                <table>
                  <thead>
                    <tr>
                      <th>Pseudo</th>
                      <th>Emplacement</th>
                      <th>Heure</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody"></tbody>
                </table>
              </div>
              <p class="note" style="margin-top:8px">Tri décroissant par date (les plus récents en haut).</p>
            </div>
          </section>
        </div>
      </section>

      <!-- ====== PANE: GESTION (NOUVEAU) ====== -->
      <section id="pane-gestion" class="pane">
        <div class="card">
          <h2 style="margin:0 0 8px 0">Gestion des utilisateurs</h2>
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <input id="userSearch" type="search" placeholder="Filtrer par pseudo ou UID…" />
              <span id="usersCount" class="muted">0 utilisateur(s)</span>
            </div>
            <div class="note">Cliquer une ligne pour afficher les actions.</div>
          </div>
          <div class="tablewrap" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th>Pseudo</th>
                  <th>UID</th>
                  <th>Dernière connexion</th>
                  <th>État</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="footer">© Le Grand Gribidouillage — Admin</div>

  <!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js" crossorigin="anonymous"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js" crossorigin="anonymous"></script>


  <script>
  // ---------- Firebase ----------
  var firebaseConfig = {
    apiKey: "AIzaSyBCy1NFYox9035-xdx52cale0gzLa5am4I",
    authDomain: "shoudinpixelwar.firebaseapp.com",
    databaseURL: "https://shoudinpixelwar-default-rtdb.europe-west1.firebasedatabase.app",
     projectId: "shoudinpixelwar",
    storageBucket: "shoudinpixelwar.appspot.com",
    messagingSenderId: "896929635521",
    appId: "1:896929635521:web:357f7b8a29cb5045684840",
    measurementId: "G-FR7NC03RCY"
  };
  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  var db = firebase.database();
  var storage = firebase.storage();
    
    // ---------- Backend API (Worker) ----------
var API_BASE = 'https://pixelwar-worker.shoudin.workers.dev';  // remplace par l’URL exacte du Worker (onglet Triggers)
var ADMIN_TOKEN = 'sk_admin_9XJcQ7eVqk8xR1tG5pZ2mH4nC6sA0bL3';    // remplace par la valeur mise dans ADMIN_TOKEN (Variables & Secrets)

    // --- helpers Worker ---
async function apiGet(path){
  const res = await fetch(API_BASE + path, {
    headers: { 'authorization': 'Bearer ' + ADMIN_TOKEN }
  });
  const j = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(j.error || ('HTTP '+res.status));
  return j;
}
async function apiPost(path, body){
  const res = await fetch(API_BASE + path, {
    method: 'POST',
    headers: {
      'content-type': 'application/json',
      'authorization': 'Bearer ' + ADMIN_TOKEN
    },
    body: JSON.stringify(body || {})
  });
  const j = await res.json().catch(()=> ({}));
  if (!res.ok) throw new Error(j.error || ('HTTP '+res.status));
  return j;
}


  // ---------- Compat utils (dates) ----------
  function supportsDateStyle(){
    try { new Intl.DateTimeFormat('fr-FR', { dateStyle:'medium' }).format(new Date()); return true; }
    catch(e){ return false; }
  }
  var HAS_DATESTYLE = supportsDateStyle();

  function fmtDateTime(ts){
    var d = new Date(ts);
    if (HAS_DATESTYLE) return new Intl.DateTimeFormat('fr-FR', { dateStyle:'medium', timeStyle:'short' }).format(d);
    function pad(n){ return String(n<10 ? '0'+n : n); }
    return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes());
  }
  function fmtDate(ts){
    var d = new Date(ts);
    if (HAS_DATESTYLE) return new Intl.DateTimeFormat('fr-FR', { dateStyle:'medium' }).format(d);
    function pad(n){ return String(n<10 ? '0'+n : n); }
    return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear();
  }
  function fmtTime(ts){
    var d = new Date(ts);
    if (HAS_DATESTYLE) return new Intl.DateTimeFormat('fr-FR', { timeStyle:'medium' }).format(d);
    function pad(n){ return String(n<10 ? '0'+n : n); }
    return pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds());
  }
  function uidShort(uid){ return uid ? String(uid).slice(0,6) : '—'; }

    // --- map UID -> IP via Worker ---
async function getIpByUid(uid){
  if (!uid) throw new Error('UID manquant');
  // Endpoint attendu côté Worker : /admin/ip-by-uid?uid=...
  // Si ton Worker ne l’a pas encore, dis-le moi : je te donne le patch Worker.
  const j = await apiGet('/admin/ip-by-uid?uid=' + encodeURIComponent(uid));
  if (!j.ok || !j.ip) throw new Error('IP introuvable pour cet UID');
  return j.ip;
}

  // ---------- Constantes ----------
  var W=300, H=300, TOTAL_CELLS=W*H;
  var EXPORT_SCALE = 4;
  var colors = [
    '#000000','#FFFFFF','#E91E63','#9C27B0','#3F51B5',
    '#03A9F4','#009688','#8BC34A','#FFEB3B','#FF9800',
    '#AD1457','#6A1B9A','#283593','#0288D1','#00695C',
    '#558B2F','#FBC02D','#EF6C00','#D84315','#795548',
    '#E0E0E0','#9E9E9E','#616161',
    '#FF0000','#FFDBAC','#F1C27D','#E0AC69'
  ];

  // ---------- Réfs UI ----------
  var tabs = document.getElementById('tabs');
  var paneDash = document.getElementById('pane-dash');
  var paneStats = document.getElementById('pane-stats');
  var paneGestion = document.getElementById('pane-gestion');
  var tabGestionBtn = document.getElementById('tab-gestion');

  var kOnline = document.getElementById('kOnline');
  var kPixels = document.getElementById('kPixels');
  var kClicks = document.getElementById('kClicks');
  var lastResetEl = document.getElementById('lastReset');
  var sysStatus = document.getElementById('sysStatus');

  var adminCodeInput = document.getElementById('adminCodeInput');
  var adminCodeCheck = document.getElementById('adminCodeCheck');
  var adminGateStatus = document.getElementById('adminGateStatus');

  var preview = document.getElementById('preview');
  var pctx = preview.getContext('2d');
  var btnRefreshPreview = document.getElementById('btnRefreshPreview');
  var btnExportPNG = document.getElementById('btnExportPNG');
  var btnArchivePNG = document.getElementById('btnArchivePNG');

  var confirmClear = document.getElementById('confirmClear');
  var btnClear = document.getElementById('btnClear');

  var historyBody = document.getElementById('historyBody');
  var btnReloadHistory = document.getElementById('btnReloadHistory');
  var histLimitSel = document.getElementById('histLimit');

  var leaderBody = document.getElementById('leaderBody');

  // Gestion
  var usersBody = document.getElementById('usersBody');
  var usersCount = document.getElementById('usersCount');
  var userSearch = document.getElementById('userSearch');

  // Chart refs
  var chart = document.getElementById('chart');
  var chartCtx = chart.getContext('2d');
  var chartNoData = document.getElementById('chartNoData');
  var dayPrev = document.getElementById('dayPrev');
  var dayNext = document.getElementById('dayNext');
  var dayLabel = document.getElementById('dayLabel');

  var ADMIN_OK=false, CURRENT_UID=null;

  // ---------- Tabs ----------
  tabs.addEventListener('click', function(e){
    var t = e.target.closest ? e.target.closest('.tab') : e.target;
    while (t && !t.classList.contains('tab')) t = t.parentNode;
    if(!t || t.classList.contains('hidden')) return;
    var all = document.querySelectorAll('.tab');
    for (var i=0;i<all.length;i++) all[i].classList.remove('active');
    t.classList.add('active');
    var id = t.getAttribute('data-tab');
    paneDash.classList.toggle('active', id==='dash');
    paneStats.classList.toggle('active', id==='stats');
    paneGestion.classList.toggle('active', id==='gestion');
  });

  // ---------- Utils ----------
  function guard(){
    btnArchivePNG.disabled = !ADMIN_OK;
    btnClear.disabled = !ADMIN_OK || confirmClear.value !== 'CLEAR';
    var card = document.getElementById('sysInfoCard');
    if (card) card.style.display = ADMIN_OK ? '' : 'none';
    tabGestionBtn.classList.toggle('hidden', !ADMIN_OK);
  }
  confirmClear.addEventListener('input', guard);

  // ---------- Auth ----------
  auth.signInAnonymously().catch(function(e){ console.error(e); });
  auth.onAuthStateChanged(function(u){ CURRENT_UID = u ? u.uid : null; });

  // ---------- Admin code ----------
  adminCodeCheck.addEventListener('click', function(){
    db.ref('config/adminCode').once('value').then(function(snap){
      var required = String(snap.val() || '');
      var typed = String(adminCodeInput.value || '');
      ADMIN_OK = required && typed && (typed === required);
      adminGateStatus.textContent = ADMIN_OK ? 'déverrouillé' : 'verrouillé';
      adminGateStatus.className = ADMIN_OK ? 'ok' : 'muted';
      guard();
    }).catch(function(){ if (sysStatus) sysStatus.textContent = 'Erreur lecture adminCode'; });
  });

  // ---------- KPIs ----------
  db.ref('presence').on('value', function(s){
    var v = s.val() || {};
    kOnline.textContent = String(Object.keys(v).length);
  });
  db.ref('stats/clicksTotal').on('value', function(s){ kClicks.textContent = String(s.val() || 0); });
  db.ref('config/lastResetAt').on('value', function(s){
  var ts = s.val();
  if (!ts) {
    lastResetEl.innerHTML = 'Reset : <span style="color:red">Pause</span>';
  } else {
    lastResetEl.innerHTML = 'Reset : <span style="color:red">Ce soir Minuit</span>';
  }
});


  // ---------- Aperçu + Export (x4) ----------
  function loadBoardToPreview(){
    return new Promise(function(resolve, reject){
      try{
        pctx.clearRect(0,0,preview.width, preview.height);
        db.ref('pixels').once('value').then(function(snap){
          var data = snap.val() || {};
          var count=0; var keys = Object.keys(data); var i=0;
          function chunk(){
            var t0 = performance.now();
            while(i<keys.length && performance.now()-t0 < 12){
              var k = keys[i++]; var v = data[k] || {};
              var xy = k.split('_'); var x = parseInt(xy[0],10), y = parseInt(xy[1],10);
              var idx = isFinite(+v.color) ? +v.color : 1;
              var col = colors[idx] || '#FFFFFF';
              if (x>=0 && x<W && y>=0 && y<H){ pctx.fillStyle=col; pctx.fillRect(x,y,1,1); count++; }
            }
            if(i<keys.length) requestAnimationFrame(chunk); else { kPixels.textContent=String(count); resolve(); }
          }
          requestAnimationFrame(chunk);
        });
      }catch(e){ reject(e); }
    });
  }
  document.getElementById('btnRefreshPreview').addEventListener('click', function(){ loadBoardToPreview(); });

  function exportScaledPNG(){
    var out = document.createElement('canvas');
    out.width = W * EXPORT_SCALE;
    out.height = H * EXPORT_SCALE;
    var octx = out.getContext('2d');
    octx.imageSmoothingEnabled = false;
    octx.drawImage(preview, 0, 0, out.width, out.height);
    out.toBlob(function(b){
      var a=document.createElement('a');
      if(!b){ a.href=out.toDataURL('image/png'); a.download='export_'+Date.now()+'_x'+EXPORT_SCALE+'.png'; document.body.appendChild(a); a.click(); a.remove(); return; }
      var url=URL.createObjectURL(b);
      a.href=url; a.download='export_'+Date.now()+'_x'+EXPORT_SCALE+'.png';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(function(){ URL.revokeObjectURL(url); },0);
    }, 'image/png');
  }
  document.getElementById('btnExportPNG').addEventListener('click', function(){
    loadBoardToPreview().then(function(){
      requestAnimationFrame(function(){ exportScaledPNG(); });
    });
  });

  document.getElementById('btnArchivePNG').addEventListener('click', function(){
    if(!ADMIN_OK) return;
    loadBoardToPreview().then(function(){
      requestAnimationFrame(function(){
        var out = document.createElement('canvas');
        out.width = W * EXPORT_SCALE; out.height = H * EXPORT_SCALE;
        var octx = out.getContext('2d'); octx.imageSmoothingEnabled=false;
        octx.drawImage(preview, 0, 0, out.width, out.height);
        out.toBlob(function(blob){
          if(!blob) return;
          var name='archive/admin_'+Date.now()+'_x'+EXPORT_SCALE+'.png';
          storage.ref().child(name).put(blob,{contentType:'image/png'}).then(function(){
            sysStatus.textContent='Archivé: '+name;
          }).catch(function(){ sysStatus.textContent='Échec archive (règles Storage ?)'; });
        }, 'image/png');
      });
    });
  });

document.getElementById('btnClear').addEventListener('click', async function(){
  if(!ADMIN_OK || confirmClear.value!=='CLEAR') return;
  if(!confirm('Confirmer la purge complète du board ?')) return;
  try{
    await doMosaicResetOnBackend();
    sysStatus.textContent = 'Purge effectuée (pixels + historique + clics = 0).';
    await loadBoardToPreview();
  }catch(e){
    console.error(e);
    sysStatus.textContent = 'Erreur purge.';
  }
});


  // ---------- Statistiques (leaderboard + history + fréquentation) ----------
  var namesByUid = {};
  function ensureName(uid){
    if(!uid || namesByUid[uid]) return Promise.resolve();
    return db.ref('users/'+uid+'/name').once('value').then(function(s){
      var n=s.val(); if(n && typeof n==='string') namesByUid[uid]=n;
    }).catch(function(){});
  }

  var historyBody = document.getElementById('historyBody');
  function loadHistory(limit){
    if(!limit) limit=200;
    historyBody.innerHTML=''; if (sysStatus) sysStatus.textContent='Chargement de l’historique…';
    db.ref('history').once('value').then(function(snap){
      var root=snap.val()||{}; var rows=[]; var coords=Object.keys(root); var i=0;
      return new Promise(function(resolve){
        function chunk(){
          var t0=performance.now();
          while(i<coords.length && performance.now()-t0<14){
            var key=coords[i++]; var xy=key.split('_'); var x=parseInt(xy[0],10), y=parseInt(xy[1],10);
            var list=root[key]||{};
            for (var pid in list){
              var v=list[pid]||{}; rows.push({ ts:+(v.ts||0), author:v.author||null, x:x, y:y });
            }
          }
          if(i<coords.length) requestAnimationFrame(chunk); else resolve(rows);
        }
        requestAnimationFrame(chunk);
      }).then(function(rows){
        rows.sort(function(a,b){ return b.ts-a.ts; });
        var take=rows.slice(0, limit);
        var uniqMap={}; var uniq=[]; for (var j=0;j<take.length;j++){ var u=take[j].author; if(u && !uniqMap[u]){ uniqMap[u]=1; uniq.push(u); } }
        return Promise.all(uniq.map(ensureName)).then(function(){
          var frag=document.createDocumentFragment();
          for (var k=0;k<take.length;k++){
            var r=take[k];
            var tr=document.createElement('tr');
            var pseudo=r.author ? (namesByUid[r.author] || uidShort(r.author)) : '—';
            var td1=document.createElement('td'); td1.textContent=pseudo;
            var td2=document.createElement('td'); td2.textContent='('+r.x+', '+r.y+')';
            var td3=document.createElement('td'); td3.textContent=r.ts?fmtTime(r.ts):'—';
            var td4=document.createElement('td'); td4.textContent=r.ts?fmtDate(r.ts):'—';
            tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
            frag.appendChild(tr);
          }
          historyBody.appendChild(frag);
          if (sysStatus) sysStatus.textContent='Historique chargé ('+take.length+' entrées).';
        });
      });
    });
  }
  document.getElementById('btnReloadHistory').addEventListener('click', function(){ var lim=parseInt(document.getElementById('histLimit').value,10)||200; loadHistory(lim); });

  var pixelOwners = {};
  var ownerCount = new Map();
  function addCount(uid){ if(!uid) return; ownerCount.set(uid,(ownerCount.get(uid)||0)+1); }
  function subCount(uid){ if(!uid) return; var n=(ownerCount.get(uid)||0)-1; if(n<=0) ownerCount.delete(uid); else ownerCount.set(uid,n); }

  function renderLeaderboard(){
    var entries=Array.from(ownerCount.entries());
    var uids=entries.map(function(p){ return p[0]; });
    Promise.all(uids.map(ensureName)).then(function(){
      var withNames=entries.filter(function(p){ return !!namesByUid[p[0]]; });
      withNames.sort(function(a,b){ return b[1]-a[1]; });
      var top=withNames.slice(0,20);
      leaderBody.innerHTML='';
      var frag=document.createDocumentFragment(); var rank=1;
      for (var i=0;i<top.length;i++){
        var uid=top[i][0], n=top[i][1];
        var tr=document.createElement('tr');
        var tdRank=document.createElement('td'); tdRank.className='right'; tdRank.textContent=String(rank++);
        var tdName=document.createElement('td'); tdName.textContent=namesByUid[uid];
        var tdN=document.createElement('td'); tdN.className='right'; tdN.textContent=String(n);
        var tdPct=document.createElement('td'); tdPct.className='right';
        var pct=(n/TOTAL_CELLS)*100; tdPct.textContent=((pct>=1)?pct.toFixed(1):pct.toFixed(2))+'%';
        tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdN); tr.appendChild(tdPct);
        frag.appendChild(tr);
      }
      leaderBody.appendChild(frag);
    });
  }

  function initLeaderboard(){
    db.ref('pixels').once('value').then(function(snap){
      var data=snap.val()||{};
      for (var k in data){
        if(!data.hasOwnProperty(k)) continue;
        var v=data[k]||{}; var uid=v.author||null; pixelOwners[k]=uid; if(uid) addCount(uid);
      }
      renderLeaderboard();
      var ref=db.ref('pixels');
      ref.on('child_added', function(s){
        var k=s.key; var v=s.val()||{}; var newUid=v.author||null;
        if (typeof pixelOwners[k] === 'undefined'){ pixelOwners[k]=newUid; if(newUid) addCount(newUid); renderLeaderboard(); }
      });
      ref.on('child_changed', function(s){
        var k=s.key; var v=s.val()||{}; var oldUid=pixelOwners[k]||null; var newUid=v.author||null;
        if (oldUid!==newUid){ if(oldUid) subCount(oldUid); pixelOwners[k]=newUid; if(newUid) addCount(newUid); renderLeaderboard(); }
      });
    });
  }

  // Fréquentation cumulée
  function dateToKey(d){ var y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2); return y+'-'+m+'-'+dd; }
  function frDayLabel(d){ if (HAS_DATESTYLE) return new Intl.DateTimeFormat('fr-FR',{ dateStyle:'medium' }).format(d); var day=('0'+d.getDate()).slice(-2), mon=('0'+(d.getMonth()+1)).slice(-2), y=d.getFullYear(); return day+'/'+mon+'/'+y; }
  var selectedDay = new Date();
  function setDayLabel(){ document.getElementById('dayLabel').textContent = frDayLabel(selectedDay); }
 
    
    function loadDayAndRender(){
  setDayLabel();
  var key = dateToKey(selectedDay);
  db.ref('stats/visitsByMinute/'+key).once('value').then(function(snap){
    var raw = snap.val() || {};
    // Série de 24*60 minutes ; null quand pas de point pour couper la ligne
    var series = [];
    for (var h=0; h<24; h++){
      for (var m=0; m<60; m++){
        var hh = ('0'+h).slice(-2);
        var mm = ('0'+m).slice(-2);
        var k  = hh+':'+mm;
        var v  = raw[k];
        series.push((typeof v === 'number') ? v : null);
      }
    }
    var hasData = series.some(function(v){ return typeof v === 'number'; });
    drawLineChart(series, hasData);
  });
}
function drawLineChart(series, hasData){
  var Wc = chart.width, Hc = chart.height;
  chartCtx.clearRect(0,0,Wc,Hc);
  chartCtx.fillStyle = '#fff'; chartCtx.fillRect(0,0,Wc,Hc);
  chartCtx.strokeStyle='#ddd'; chartCtx.lineWidth=1;

  var left=40, right=8, top=8, bottom=22;
  var plotW = Wc-left-right, plotH=Hc-top-bottom;

  // max Y (≥1)
  var maxY = 1;
  for (var i=0;i<series.length;i++){
    var v = series[i];
    if (typeof v === 'number' && v > maxY) maxY = v;
  }

  // Grille + labels
  var steps=4;
  chartCtx.fillStyle='#666'; chartCtx.font='12px system-ui';
  for(var i=0;i<=steps;i++){
    var y = top + plotH*(1 - i/steps);
    chartCtx.beginPath(); chartCtx.moveTo(left,y); chartCtx.lineTo(left+plotW,y); chartCtx.stroke();
    var val = Math.round(maxY * i/steps);
    chartCtx.fillText(String(val), 6, y-2);
  }

  // Ticks heures (0,6,12,18,24)
  for(var h=0; h<=24; h+=6){
    var idx = Math.min(series.length-1, h*60);
    var x = left + plotW*(idx/(series.length-1));
    chartCtx.beginPath(); chartCtx.moveTo(x, top+plotH); chartCtx.lineTo(x, top+plotH+4); chartCtx.stroke();
    chartCtx.fillText(String(h)+'h', x-8, top+plotH+16);
  }

  var chartNoData = document.getElementById('chartNoData');
  if (!hasData){ chartNoData.style.display='flex'; return; } else { chartNoData.style.display='none'; }

  // Tracé segmenté (ne relie pas à travers les trous)
  chartCtx.beginPath();
  chartCtx.strokeStyle='#111'; chartCtx.lineWidth=2;
  var inSeg = false;
  for(var k=0;k<series.length;k++){
    var v = series[k];
    var x = left + plotW*(k/(series.length-1));
    if (typeof v === 'number'){
      var y = top + plotH*(1 - (v/maxY));
      if (!inSeg){ chartCtx.moveTo(x,y); inSeg = true; } else { chartCtx.lineTo(x,y); }
    } else {
      inSeg = false;
    }
  }
  chartCtx.stroke();

  // **Points** pour chaque minute mesurée (visible même si isolée)
  chartCtx.fillStyle = '#111';
  var r = 2.5;
  for(var k=0;k<series.length;k++){
    var v = series[k];
    if (typeof v === 'number'){
      var x = left + plotW*(k/(series.length-1));
      var y = top + plotH*(1 - (v/maxY));
      chartCtx.beginPath();
      chartCtx.arc(x, y, r, 0, Math.PI*2);
      chartCtx.fill();
    }
  }
}

  document.getElementById('dayPrev').addEventListener('click', function(){ selectedDay = new Date(selectedDay.getTime()-24*3600*1000); loadDayAndRender(); });
  document.getElementById('dayNext').addEventListener('click', function(){ selectedDay = new Date(selectedDay.getTime()+24*3600*1000); loadDayAndRender(); });

  // ---------- Gestion (liste + actions) ----------
  var namesAll = {};          // uid -> pseudo
  var lastSeenByUid = {};     // uid -> ts (optionnel si tu l’enregistres côté client)
  var onlineSet = new Set();  // uids en ligne (presence)
  var bannedSet = new Set();  // uids bannis

  // presence
  db.ref('presence').on('child_added', function(s){ onlineSet.add(s.key); renderUsers(); });
  db.ref('presence').on('child_removed', function(s){ onlineSet.delete(s.key); renderUsers(); });

  // banned
  db.ref('banned').on('value', function(s){
    bannedSet.clear(); var v=s.val()||{};
    Object.keys(v).forEach(function(uid){ bannedSet.add(uid); });
    renderUsers();
  });

  // users (pseudos + lastSeen éventuel)
  db.ref('users').on('child_added', function(s){
    var uid=s.key, v=s.val()||{};
    if (v.name) namesAll[uid]=v.name; else delete namesAll[uid];
    if (typeof v.lastSeen==='number') lastSeenByUid[uid]=v.lastSeen;
    renderUsers();
  });
  db.ref('users').on('child_changed', function(s){
    var uid=s.key, v=s.val()||{};
    if (v.name) namesAll[uid]=v.name; else delete namesAll[uid];
    if (typeof v.lastSeen==='number') lastSeenByUid[uid]=v.lastSeen;
    renderUsers();
  });

  function fmtSeen(uid){
    var ts = lastSeenByUid[uid];
    if (ts) return fmtDateTime(ts);
    // fallback : si en ligne, on peut montrer "en ligne"
    return onlineSet.has(uid) ? 'en ligne' : '—';
    // Tu peux aussi, si tu veux, enregistrer lastSeen lors des connexions côté index pour être précis.
  }

  function matchesFilter(uid, name, q){
    if (!q) return true;
    q = q.toLowerCase();
    return (name && name.toLowerCase().includes(q)) || uid.toLowerCase().includes(q);
  }

  function renderUsers(){
    if (!usersBody) return;
    var q = (userSearch.value||'').trim();
    usersBody.innerHTML = '';
    var entries = Object.entries(namesAll)
      .filter(function(pair){ return matchesFilter(pair[0], pair[1], q); })
      .sort(function(a,b){ return a[1].localeCompare(b[1], 'fr', { sensitivity:'base' }); });

    var frag = document.createDocumentFragment();
    var count = 0;

    entries.forEach(function(pair){
      var uid = pair[0], name = pair[1];
      var tr = document.createElement('tr');

      var tdName = document.createElement('td'); tdName.textContent = name;
      var tdUid  = document.createElement('td'); tdUid.innerHTML = '<span class="uid">'+uid+'</span>';
      var tdSeen = document.createElement('td'); tdSeen.textContent = fmtSeen(uid);
      var tdState= document.createElement('td');
      var badges = [];
      if (onlineSet.has(uid)) badges.push('<span class="badge online">En ligne</span>');
      if (bannedSet.has(uid)) badges.push('<span class="badge banned">Banni</span>');
      tdState.innerHTML = badges.join(' ');

      var tdAct  = document.createElement('td');
      var actions = document.createElement('div'); actions.className='row-actions'; actions.style.visibility='hidden';

      var btnBan = document.createElement('button'); btnBan.className='danger'; btnBan.textContent='Bannir';
      btnBan.title = 'Bannir l’UID et effacer tous ses pixels';
      btnBan.addEventListener('click', function(e){ e.stopPropagation(); banUser(uid, name); });

      var btnErase = document.createElement('button'); btnErase.textContent='Effacer';
      btnErase.title = 'Supprimer le pseudo (le rendre disponible)';
      btnErase.addEventListener('click', function(e){ e.stopPropagation(); erasePseudo(uid, name); });

      actions.appendChild(btnBan); actions.appendChild(btnErase);
      tdAct.appendChild(actions);

      tr.appendChild(tdName); tr.appendChild(tdUid); tr.appendChild(tdSeen); tr.appendChild(tdState); tr.appendChild(tdAct);

      tr.addEventListener('click', function(){
        var already = tr.classList.contains('sel');
        var all = usersBody.querySelectorAll('tr'); for (var i=0;i<all.length;i++){ all[i].classList.remove('sel'); all[i].querySelector('.row-actions').style.visibility='hidden'; }
        if (!already){ tr.classList.add('sel'); actions.style.visibility='visible'; }
      });

      frag.appendChild(tr); count++;
    });

    usersBody.appendChild(frag);
    usersCount.textContent = count + ' utilisateur(s)';
  }
  userSearch.addEventListener('input', renderUsers);

  async function erasePseudo(uid, name){
    if(!ADMIN_OK){ alert('Accès admin requis.'); return; }
    var ok = confirm('Effacer le pseudo de '+(name||uid)+' ?\nLe pseudo redeviendra disponible.');
    if (!ok) return;
    try{
      var snap = await db.ref('users/'+uid+'/name').once('value');
      var currentName = snap.val();
      if (currentName){
        var key = currentName.toLowerCase().replace(/[^a-z0-9_]/g,'');
        await db.ref('users_by_name/'+key).transaction(function(cur){ return (cur===uid) ? null : cur; });
      }
      await db.ref('users/'+uid+'/name').remove();
      alert('Pseudo effacé.');
    }catch(e){ console.error(e); alert('Erreur pendant la suppression du pseudo.'); }
  }

 async function banUser(uid, name){
  if(!ADMIN_OK){ alert('Accès admin requis.'); return; }
  const label = (name || uid);
  const ok = confirm(
    'BANNIR définitivement ' + label + ' ?\n\n' +
    '• Résout son IP (via Worker)\n' +
    '• Ban IP PERMANENT (KV)\n' +
    '• Efface tous ses pixels (UID) dans la RTDB\n' +
    '• Marque /banned/{uid}=true pour l’UI'
  );
  if (!ok) return;

  try{
    // 1) Trouver son IP
    const ip = await getIpByUid(uid);

    // 2) Ban IP permanent (ttl = 0 → définitif)
    await apiPost('/admin/ban', { ip, reason: 'admin-ban', minutes: 0 });

    // 3) Effacer pixels de cet UID dans Firebase
    const q = db.ref('pixels').orderByChild('author').equalTo(uid);
    const snap = await q.once('value');
    const updates = {};
    snap.forEach(child => {
      const k = child.key;
      updates['pixels/'+k] = { color: 1, author: null, ts: null }; // 1 = blanc
    });
    if (Object.keys(updates).length) await db.ref().update(updates);

    // 4) Marqueur UI (badge)
    await db.ref('banned/'+uid).set(true);

    alert(`OK : ${label} banni (IP ${ip}) et pixels effacés.`);
  } catch (e){
    console.error(e);
    alert('Erreur pendant le bannissement : ' + (e.message || e));
  }
}


  // ---------- Init ----------
  loadBoardToPreview();
  initLeaderboard();

  document.querySelector('.tab[data-tab="stats"]').addEventListener('click', function(){
    if (!historyBody.children.length){
      var lim=parseInt(document.getElementById('histLimit').value,10)||200;
      loadHistory(lim);
    }
    loadDayAndRender();
  });

  // Gestion: re-render quand on ouvre l'onglet
  document.getElementById('tab-gestion').addEventListener('click', function(){
    renderUsers();
  });
    
async function doMosaicResetOnBackend(){
  // 1) Appel du Worker : efface pixels (+ history si configuré côté Worker)
  var res = await fetch(API_BASE + '/admin/reset-mosaic', {
    method: 'POST',
    headers: {
      'content-type': 'application/json',
      'authorization': 'Bearer ' + ADMIN_TOKEN
    },
    body: '{}' // payload vide
  });
  var j = await res.json().catch(function(){ return {}; });
  if (!res.ok || !j.ok) {
    throw new Error('Backend reset failed: ' + (j.error || ('HTTP '+res.status)));
  }

  // 2) Mise à jour des méta-infos côté RTDB (facultatif mais utile pour l’UI)
  //    - Remet les compteurs (si tu les utilises)
  //    - Marque la date du dernier reset
  var root = db.ref();
  var updates = {
    'stats/clicksTotal': 0,
    'config/lastResetAt': firebase.database.ServerValue.TIMESTAMP
  };
  await root.update(updates);
}


  </script>
</body>
</html>
