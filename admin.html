<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Admin — Le Grand Gribidouillage</title>
  <style>
    :root{ --pad:16px; --gap:12px; --card:#fff; --ink:#111; --muted:#666; --bd:#ddd; }
    *{ box-sizing:border-box; }
    html,body{ margin:0; background:#f6f7f9; color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header{ padding: var(--pad); border-bottom:1px solid var(--bd); background:#fff; position:sticky; top:0; z-index:20; }
    h1{ margin:0; font-size:20px; }
    .wrap{ padding: var(--pad); }
    .card{ background:var(--card); border:1px solid var(--bd); border-radius:12px; padding: var(--pad); }
    .row{ display:flex; gap: var(--gap); align-items:center; flex-wrap:wrap; }
    .grid{ display:grid; gap: var(--gap); }
    .grid.cols2{ grid-template-columns: 1.1fr 1fr; align-items:start; }
    label.inline{ display:flex; gap:8px; align-items:center; }
    .muted{ color: var(--muted); }
    button{ padding:8px 12px; border-radius:10px; border:1px solid #bbb; background:#fff; cursor:pointer; font-weight:600; }
    button[disabled]{ opacity:.5; cursor:not-allowed; }
    input[type="password"], input[type="text"], input[type="search"], select{ padding:8px 10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
    .kpi{ display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); }
    .kpi .item{ padding:14px; border:1px solid var(--bd); border-radius:12px; background:#fff; }
    .kpi .n{ font-size:22px; font-weight:800; }
    canvas{ image-rendering: pixelated; border:1px solid #333; background:#fff; }

    /* Tabs */
    .tabs{ display:flex; gap:8px; border-bottom:1px solid var(--bd); margin-bottom:12px; }
    .tab{ padding:8px 12px; border:1px solid var(--bd); border-bottom:none; border-radius:10px 10px 0 0; background:#fafafa; cursor:pointer; }
    .tab.active{ background:#fff; font-weight:700; }
    .tab.hidden{ display:none; }
    .tabpanes > .pane{ display:none; }
    .tabpanes > .pane.active{ display:block; }

    .danger{ color:#b00020; border-color:#b00020; }
    .ok{ color:#0a7a20; }
    .note{ font-size:12px; }
    .footer{ padding: var(--pad); text-align:center; color:var(--muted); }

    table{ width:100%; border-collapse: collapse; }
    th, td{ text-align:left; padding:8px 10px; border-bottom:1px solid var(--bd); font-size:14px; }
    th{ background:#fafafa; position:sticky; top:0; z-index:10; }
    .tablewrap{ max-height: 60vh; overflow:auto; border:1px solid var(--bd); border-radius:10px; background:#fff; }
    .right{ text-align:right; }

    /* Chart */
    .charthead{ display:flex; align-items:center; gap:8px; }
    .daynav{ display:flex; align-items:center; gap:4px; }
    .daynav button{ width:32px; height:28px; font-weight:700; }
    #chartWrap{ position:relative; width:100%; max-width:680px; }
    #chartNoData{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.85); font-size:14px; }

    /* Gestion */
    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; background:#fff; }
    .badge.online{ color:#0a7; border-color:#7bd; background:#f0fffb; }
    .badge.banned{ color:#b00020; border-color:#e7a3a8; background:#fff5f6; }
    .uid{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; opacity:.85; }
    .row-actions{ display:flex; gap:8px; }
    .row.sel{ background:#f2f6ff; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Admin — Le Grand Gribidouillage</h1>
      <span class="muted">• contrôle & maintenance</span>
    </div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="dash">Tableau de bord</div>
      <div class="tab" data-tab="stats">Statistiques</div>
      <div class="tab hidden" data-tab="gestion" id="tab-gestion">Gestion</div>
    </div>
  </header>

  <div class="wrap">
    <div class="tabpanes">
      <!-- ====== PANE: DASHBOARD ====== -->
      <section id="pane-dash" class="pane active">
        <div class="grid cols2">
          <!-- Colonne A -->
          <section class="grid">
            <div class="card">
              <h2 style="margin-top:0">Accès admin</h2>
              <p class="muted">Saisis le <strong>code admin</strong> défini dans <code>config/adminCode</code> (Realtime DB).</p>
              <div class="row">
                <input id="adminCodeInput" type="password" placeholder="••••••••" />
                <button id="adminCodeCheck">Déverrouiller</button>
                <span id="adminGateStatus" class="muted">verrouillé</span>
              </div>
              <p class="note">Tant que non déverrouillé, les actions critiques restent désactivées.</p>
            </div>

            <div class="card">
              <h2 style="margin-top:0">Stats</h2>
              <div class="kpi">
                <div class="item">
                  <div class="muted">Connectés</div>
                  <div id="kOnline" class="n">—</div>
                </div>
                <div class="item">
                  <div class="muted">Pixels posés</div>
                  <div id="kPixels" class="n">—</div>
                </div>
                <div class="item">
                  <div class="muted">Clics total</div>
                  <div id="kClicks" class="n">—</div>
                </div>
              </div>
              <div class="row" style="margin-top:12px">
                <div class="muted">Dernier reset :</div>
                <div id="lastReset">—</div>
              </div>
            </div>

            <div class="card">
              <h2 style="margin-top:0">Aperçu mosaïque</h2>
              <div class="row">
                <canvas id="preview" width="300" height="300"></canvas>
                <div class="grid" style="align-content:start">
                  <button id="btnRefreshPreview">Rafraîchir</button>
                  <button id="btnExportPNG">Exporter PNG</button>
                  <button id="btnArchivePNG" disabled>Archiver vers Storage</button>
                  <span class="note">Export 1200×1200, rendu net (x4).</span>
                </div>
              </div>
            </div>
          </section>

          <!-- Colonne B -->
          <section class="grid">
            <div class="card">
              <h2 style="margin-top:0">Actions</h2>
              <div class="grid">
                <div>
                  <div class="muted">Purge complète (efface <code>pixels/</code> & écrit <code>config/lastResetAt</code>)</div>
                  <div class="row" style="margin-top:8px">
                    <input id="confirmClear" type="text" placeholder='Tape "CLEAR" pour confirmer' />
                    <button id="btnClear" class="danger" disabled>Vider la mosaïque</button>
                  </div>
                  <p class="note">⚠️ Irréversible. Sauvegarde/Archive avant !</p>
                </div>
              </div>
            </div>

            <!-- Infos système masquée tant que l’admin n’est pas validé -->
            <div class="card" id="sysInfoCard" style="display:none">
              <h2 style="margin-top:0">Infos système</h2>
              <ul class="note">
                <li>SDK: Firebase compat 10.12.2</li>
                <li>DB: <code>pixels/{x}_{y} → { color:number, author?:uid, ts?:number }</code></li>
                <li>Historique: <code>history/{x}_{y}/{pushId} → { color, author, ts }</code></li>
                <li>Fréquentation: <code>stats/visitsByMinute/YYYY-MM-DD/{HH:mm}</code></li>
                <li>Archive Storage: <code>archive/</code></li>
              </ul>
              <div id="sysStatus" class="muted">Prêt.</div>
            </div>
          </section>
        </div>
      </section>

      <!-- ====== PANE: STATISTIQUES ====== -->
      <section id="pane-stats" class="pane">
        <div class="grid cols2">
          <!-- Colonne A : Hit parade -->
          <section class="grid">
            <div class="card">
              <h2 style="margin:0 0 8px 0">Hit parade (temps réel)</h2>
              <p class="note" style="margin-top:0">Classement par nombre de pixels actuellement détenus sur la mosaïque. <em>(UIDs sans pseudo exclus)</em></p>
              <div class="tablewrap">
                <table>
                  <thead>
                    <tr>
                      <th class="right">#</th>
                      <th>Pseudo</th>
                      <th class="right">Pixels</th>
                      <th class="right">%</th>
                    </tr>
                  </thead>
                  <tbody id="leaderBody"></tbody>
                </table>
              </div>
              <p class="note">Top 20, mise à jour automatique.</p>
            </div>
          </section>

          <!-- Colonne B : Fréquentation + Historique -->
          <section class="grid">
            <div class="card">
              <div class="row" style="justify-content:space-between; align-items:center">
               <h2 style="margin:0">Connexions par minute</h2>
                <div class="daynav">
                  <button id="dayPrev" title="Jour précédent">⟨</button>
                  <span id="dayLabel" class="muted">—</span>
                  <button id="dayNext" title="Jour suivant">⟩</button>
                </div>
              </div>
              <div id="chartWrap" style="margin-top:8px">
                <canvas id="chart" width="680" height="240"></canvas>
                <div id="chartNoData">Aucune donnée pour ce jour</div>
              </div>
             <p class="note" style="margin-top:8px">Source: <code>stats/visitsByMinute/YYYY-MM-DD/HH:mm</code>. Ligne = visites/minute (chargements de la mosaïque).</p>
            </div>

            <div class="card">
              <div class="row" style="justify-content:space-between">
                <h2 style="margin:0">Historique des poses</h2>
                <div class="row">
                  <label class="inline">
                    Limite:
                    <select id="histLimit">
                      <option value="100">100</option>
                      <option value="200" selected>200</option>
                      <option value="300">300</option>
                      <option value="500">500</option>
                    </select>
                  </label>
                  <button id="btnReloadHistory">Rafraîchir</button>
                </div>
              </div>
              <div class="tablewrap" style="margin-top:12px">
                <table>
                  <thead>
                    <tr>
                      <th>Pseudo</th>
                      <th>Emplacement</th>
                      <th>Heure</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody"></tbody>
                </table>
              </div>
              <p class="note" style="margin-top:8px">Tri décroissant par date (les plus récents en haut).</p>
            </div>
          </section>
        </div>
      </section>

      <!-- ====== PANE: GESTION ====== -->
      <section id="pane-gestion" class="pane">
        <div class="card">
          <h2 style="margin:0 0 8px 0">Gestion des utilisateurs</h2>
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <input id="userSearch" type="search" placeholder="Filtrer par pseudo ou UID…" />
              <span id="usersCount" class="muted">0 utilisateur(s)</span>
            </div>
            <div class="note">Cliquer une ligne pour afficher les actions.</div>
          </div>
          <div class="tablewrap" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th>Pseudo</th>
                  <th>UID</th>
                  <th>Dernière connexion</th>
                  <th>État</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="footer">© Le Grand Gribidouillage — Admin</div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js" crossorigin="anonymous"></script>

  <script>
  // ---------- Firebase (ALIGNÉ SUR L’INDEX) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCxWxz9Nf97tBwIilvCgqQ7yVk3gMPC4Cs",
    authDomain: "le-grand-gribidouillage.firebaseapp.com",
    databaseURL: "https://le-grand-gribidouillage-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "le-grand-gribidouillage",
    storageBucket: "le-grand-gribidouillage.appspot.com",
    messagingSenderId: "999048366927",
    appId: "1:999048366927:web:1120aca9e541873a93d33a"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();
  const storage = firebase.storage();

  // ---------- Compat utils (dates) ----------
  function supportsDateStyle(){
    try { new Intl.DateTimeFormat('fr-FR', { dateStyle:'medium' }).format(new Date()); return true; }
    catch(e){ return false; }
  }
  const HAS_DATESTYLE = supportsDateStyle();

  function fmtDateTime(ts){
    const d = new Date(ts);
    if (HAS_DATESTYLE) return new Intl.DateTimeFormat('fr-FR', { dateStyle:'medium', timeStyle:'short' }).format(d);
    const pad = n => String(n<10 ? '0'+n : n);
    return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes());
  }
  function fmtDate(ts){
    const d = new Date(ts);
    if (HAS_DATESTYLE) return new Intl.DateTimeFormat('fr-FR', { dateStyle:'medium' }).format(d);
    const pad = n => String(n<10 ? '0'+n : n);
    return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear();
  }
  function fmtTime(ts){
    const d = new Date(ts);
    if (HAS_DATESTYLE) return new Intl.DateTimeFormat('fr-FR', { timeStyle:'medium' }).format(d);
    const pad = n => String(n<10 ? '0'+n : n);
    return pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds());
  }
  const uidShort = uid => uid ? String(uid).slice(0,6) : '—';

  // ---------- Constantes ----------
  const W=300, H=300, TOTAL_CELLS=W*H;
  const EXPORT_SCALE = 4;
  const colors = [
    '#000000','#FFFFFF','#E91E63','#9C27B0','#3F51B5',
    '#03A9F4','#009688','#8BC34A','#FFEB3B','#FF9800',
    '#AD1457','#6A1B9A','#283593','#0288D1','#00695C',
    '#558B2F','#FBC02D','#EF6C00','#D84315','#795548',
    '#E0E0E0','#9E9E9E','#616161',
    '#FF0000','#FFDBAC','#F1C27D','#E0AC69'
  ];

  // ---------- Réfs UI ----------
  const tabs = document.getElementById('tabs');
  const paneDash = document.getElementById('pane-dash');
  const paneStats = document.getElementById('pane-stats');
  const paneGestion = document.getElementById('pane-gestion');
  const tabGestionBtn = document.getElementById('tab-gestion');

  const kOnline = document.getElementById('kOnline');
  const kPixels = document.getElementById('kPixels');
  const kClicks = document.getElementById('kClicks');
  const lastResetEl = document.getElementById('lastReset');
  const sysStatus = document.getElementById('sysStatus');

  const adminCodeInput = document.getElementById('adminCodeInput');
  const adminCodeCheck = document.getElementById('adminCodeCheck');
  const adminGateStatus = document.getElementById('adminGateStatus');

  const preview = document.getElementById('preview');
  const pctx = preview.getContext('2d');
  const btnRefreshPreview = document.getElementById('btnRefreshPreview');
  const btnExportPNG = document.getElementById('btnExportPNG');
  const btnArchivePNG = document.getElementById('btnArchivePNG');

  const confirmClear = document.getElementById('confirmClear');
  const btnClear = document.getElementById('btnClear');

  const historyBody = document.getElementById('historyBody');
  const btnReloadHistory = document.getElementById('btnReloadHistory');
  const histLimitSel = document.getElementById('histLimit');

  const leaderBody = document.getElementById('leaderBody');

  // Gestion
  const usersBody = document.getElementById('usersBody');
  const usersCount = document.getElementById('usersCount');
  const userSearch = document.getElementById('userSearch');

  // Chart refs
  const chart = document.getElementById('chart');
  const chartCtx = chart.getContext('2d');
  const chartNoData = document.getElementById('chartNoData');
  const dayPrev = document.getElementById('dayPrev');
  const dayNext = document.getElementById('dayNext');
  const dayLabel = document.getElementById('dayLabel');

  let ADMIN_OK=false, CURRENT_UID=null;

  // ---------- Tabs ----------
  tabs.addEventListener('click', (e)=>{
    let t = e.target.closest ? e.target.closest('.tab') : e.target;
    while (t && !t.classList.contains('tab')) t = t.parentNode;
    if(!t || t.classList.contains('hidden')) return;
    document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
    t.classList.add('active');
    const id = t.getAttribute('data-tab');
    paneDash.classList.toggle('active', id==='dash');
    paneStats.classList.toggle('active', id==='stats');
    paneGestion.classList.toggle('active', id==='gestion');
  });

  // ---------- Utils ----------
  function guard(){
    btnArchivePNG.disabled = !ADMIN_OK;
    btnClear.disabled = !ADMIN_OK || confirmClear.value !== 'CLEAR';
    const card = document.getElementById('sysInfoCard');
    if (card) card.style.display = ADMIN_OK ? '' : 'none';
    tabGestionBtn.classList.toggle('hidden', !ADMIN_OK);
  }
  confirmClear.addEventListener('input', guard);

  // ---------- Auth ----------
  auth.signInAnonymously().catch(console.error);
  auth.onAuthStateChanged(u => { CURRENT_UID = u ? u.uid : null; });

  // ---------- Admin code ----------
  adminCodeCheck.addEventListener('click', ()=>{
    db.ref('config/adminCode').once('value').then(snap=>{
      const required = String(snap.val() || '');
      const typed = String(adminCodeInput.value || '');
      ADMIN_OK = required && typed && (typed === required);
      adminGateStatus.textContent = ADMIN_OK ? 'déverrouillé' : 'verrouillé';
      adminGateStatus.className = ADMIN_OK ? 'ok' : 'muted';
      guard();
    }).catch(()=>{ if (sysStatus) sysStatus.textContent = 'Erreur lecture adminCode'; });
  });

  // ---------- KPIs ----------
  db.ref('presence').on('value', s=>{
    const v = s.val() || {};
    kOnline.textContent = String(Object.keys(v).length);
  });
  db.ref('stats/clicksTotal').on('value', s=>{ kClicks.textContent = String(s.val() || 0); });
  db.ref('config/lastResetAt').on('value', s=>{
    const ts = s.val();
    if (!ts) lastResetEl.innerHTML = 'Reset : <span style="color:red">Pause</span>';
    else     lastResetEl.innerHTML = 'Reset : <span style="color:red">Ce soir Minuit</span>';
  });

  // ---------- Aperçu + Export (x4) ----------
  function loadBoardToPreview(){
    return new Promise((resolve)=>{
      try{
        pctx.clearRect(0,0,preview.width, preview.height);
        db.ref('pixels').once('value').then(snap=>{
          const data = snap.val() || {};
          let count=0; const keys = Object.keys(data); let i=0;
          function chunk(){
            const t0 = performance.now();
            while(i<keys.length && performance.now()-t0 < 12){
              const k = keys[i++]; const v = data[k] || {};
              const [x,y] = k.split('_').map(n=>parseInt(n,10));
              const idx = Number.isFinite(+v.color) ? +v.color : 1;
              const col = colors[idx] || '#FFFFFF';
              if (x>=0 && x<W && y>=0 && y<H){ pctx.fillStyle=col; pctx.fillRect(x,y,1,1); count++; }
            }
            if(i<keys.length) requestAnimationFrame(chunk); else { kPixels.textContent=String(count); resolve(); }
          }
          requestAnimationFrame(chunk);
        });
      }catch{ resolve(); }
    });
  }
  btnRefreshPreview.addEventListener('click', ()=> loadBoardToPreview());
  btnExportPNG.addEventListener('click', ()=>{
    loadBoardToPreview().then(()=>{
      requestAnimationFrame(()=>{
        const out = document.createElement('canvas');
        out.width = W * EXPORT_SCALE; out.height = H * EXPORT_SCALE;
        const octx = out.getContext('2d'); octx.imageSmoothingEnabled = false;
        octx.drawImage(preview, 0, 0, out.width, out.height);
        out.toBlob(b=>{
          const a=document.createElement('a');
          if(!b){ a.href=out.toDataURL('image/png'); a.download='export_'+Date.now()+'_x'+EXPORT_SCALE+'.png'; document.body.appendChild(a); a.click(); a.remove(); return; }
          const url=URL.createObjectURL(b);
          a.href=url; a.download='export_'+Date.now()+'_x'+EXPORT_SCALE+'.png';
          document.body.appendChild(a); a.click(); a.remove();
          setTimeout(()=>URL.revokeObjectURL(url),0);
        }, 'image/png');
      });
    });
  });
  btnArchivePNG.addEventListener('click', ()=>{
    if(!ADMIN_OK) return;
    loadBoardToPreview().then(()=>{
      requestAnimationFrame(()=>{
        const out = document.createElement('canvas');
        out.width = W * EXPORT_SCALE; out.height = H * EXPORT_SCALE;
        const octx = out.getContext('2d'); octx.imageSmoothingEnabled=false;
        octx.drawImage(preview, 0, 0, out.width, out.height);
        out.toBlob(blob=>{
          if(!blob) return;
          const name='archive/admin_'+Date.now()+'_x'+EXPORT_SCALE+'.png';
          storage.ref().child(name).put(blob,{contentType:'image/png'}).then(()=>{
            sysStatus.textContent='Archivé: '+name;
          }).catch(()=>{ sysStatus.textContent='Échec archive (règles Storage ?)'; });
        }, 'image/png');
      });
    });
  });

  // ---------- Actions critiques ----------
  document.getElementById('btnClear').addEventListener('click', async ()=>{
    if(!ADMIN_OK || confirmClear.value!=='CLEAR') return;
    if(!confirm('Confirmer la purge complète du board ?')) return;
    try{
      await doMosaicResetFirebaseOnly();
      sysStatus.textContent = 'Purge effectuée (pixels + historique + clics = 0).';
      await loadBoardToPreview();
    }catch(e){
      console.error(e);
      sysStatus.textContent = 'Erreur purge.';
    }
  });

  // ---------- Statistiques (leaderboard + history + fréquentation) ----------
  const namesByUid = {};
  function ensureName(uid){
    if(!uid || namesByUid[uid]) return Promise.resolve();
    return db.ref('users/'+uid+'/name').once('value').then(s=>{
      const n=s.val(); if(n && typeof n==='string') namesByUid[uid]=n;
    }).catch(()=>{});
  }

  function loadHistory(limit){
    if(!limit) limit=200;
    historyBody.innerHTML=''; if (sysStatus) sysStatus.textContent='Chargement de l’historique…';
    db.ref('history').once('value').then(snap=>{
      const root=snap.val()||{}; const rows=[]; const coords=Object.keys(root); let i=0;
      return new Promise(resolve=>{
        function chunk(){
          const t0=performance.now();
          while(i<coords.length && performance.now()-t0<14){
            const key=coords[i++]; const [x,y]=key.split('_').map(n=>parseInt(n,10));
            const list=root[key]||{};
            for (const pid in list){
              const v=list[pid]||{}; rows.push({ ts:+(v.ts||0), author:v.author||null, x:x, y:y });
            }
          }
          if(i<coords.length) requestAnimationFrame(chunk); else resolve(rows);
        }
        requestAnimationFrame(chunk);
      }).then(rows=>{
        rows.sort((a,b)=> b.ts-a.ts);
        const take=rows.slice(0, limit);
        const uniq=[...new Set(take.map(r=>r.author).filter(Boolean))];
        return Promise.all(uniq.map(ensureName)).then(()=>{
          const frag=document.createDocumentFragment();
          take.forEach(r=>{
            const tr=document.createElement('tr');
            const pseudo=r.author ? (namesByUid[r.author] || uidShort(r.author)) : '—';
            const td1=document.createElement('td'); td1.textContent=pseudo;
            const td2=document.createElement('td'); td2.textContent='('+r.x+', '+r.y+')';
            const td3=document.createElement('td'); td3.textContent=r.ts?fmtTime(r.ts):'—';
            const td4=document.createElement('td'); td4.textContent=r.ts?fmtDate(r.ts):'—';
            tr.append(td1,td2,td3,td4);
            frag.appendChild(tr);
          });
          historyBody.appendChild(frag);
          if (sysStatus) sysStatus.textContent='Historique chargé ('+take.length+' entrées).';
        });
      });
    });
  }
  document.getElementById('btnReloadHistory').addEventListener('click', ()=>{
    const lim=parseInt(document.getElementById('histLimit').value,10)||200; loadHistory(lim);
  });

  const pixelOwners = {};
  const ownerCount = new Map();
  const addCount = uid => { if(!uid) return; ownerCount.set(uid,(ownerCount.get(uid)||0)+1); };
  const subCount = uid => { if(!uid) return; const n=(ownerCount.get(uid)||0)-1; if(n<=0) ownerCount.delete(uid); else ownerCount.set(uid,n); };

  function renderLeaderboard(){
    const entries=Array.from(ownerCount.entries());
    const uids=entries.map(p=>p[0]);
    Promise.all(uids.map(ensureName)).then(()=>{
      const withNames=entries.filter(p=> !!namesByUid[p[0]]);
      withNames.sort((a,b)=> b[1]-a[1]);
      const top=withNames.slice(0,20);
      leaderBody.innerHTML='';
      const frag=document.createDocumentFragment(); let rank=1;
      top.forEach(([uid,n])=>{
        const tr=document.createElement('tr');
        const tdRank=document.createElement('td'); tdRank.className='right'; tdRank.textContent=String(rank++);
        const tdName=document.createElement('td'); tdName.textContent=namesByUid[uid];
        const tdN=document.createElement('td'); tdN.className='right'; tdN.textContent=String(n);
        const tdPct=document.createElement('td'); tdPct.className='right';
        const pct=(n/TOTAL_CELLS)*100; tdPct.textContent=((pct>=1)?pct.toFixed(1):pct.toFixed(2))+'%';
        tr.append(tdRank,tdName,tdN,tdPct);
        frag.appendChild(tr);
      });
      leaderBody.appendChild(frag);
    });
  }

  function initLeaderboard(){
    db.ref('pixels').once('value').then(snap=>{
      const data=snap.val()||{};
      for (const k in data){
        const v=data[k]||{}; const uid=v.author||null; pixelOwners[k]=uid; if(uid) addCount(uid);
      }
      renderLeaderboard();
      const ref=db.ref('pixels');
      ref.on('child_added', s=>{
        const k=s.key; const v=s.val()||{}; const newUid=v.author||null;
        if (typeof pixelOwners[k] === 'undefined'){ pixelOwners[k]=newUid; if(newUid) addCount(newUid); renderLeaderboard(); }
      });
      ref.on('child_changed', s=>{
        const k=s.key; const v=s.val()||{}; const oldUid=pixelOwners[k]||null; const newUid=v.author||null;
        if (oldUid!==newUid){ if(oldUid) subCount(oldUid); pixelOwners[k]=newUid; if(newUid) addCount(newUid); renderLeaderboard(); }
      });
    });
  }

  // Fréquentation cumulée
  const dateToKey = d => {
    const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
    return y+'-'+m+'-'+dd;
  };
  const frDayLabel = d => HAS_DATESTYLE ? new Intl.DateTimeFormat('fr-FR',{ dateStyle:'medium' }).format(d)
                                        : (('0'+d.getDate()).slice(-2)+'/'+('0'+(d.getMonth()+1)).slice(-2)+'/'+d.getFullYear());
  let selectedDay = new Date();
  function setDayLabel(){ dayLabel.textContent = frDayLabel(selectedDay); }

  function loadDayAndRender(){
    setDayLabel();
    const key = dateToKey(selectedDay);
    db.ref('stats/visitsByMinute/'+key).once('value').then(snap=>{
      const raw = snap.val() || {};
      const series = [];
      for (let h=0; h<24; h++){
        for (let m=0; m<60; m++){
          const hh = ('0'+h).slice(-2);
          const mm = ('0'+m).slice(-2);
          const k  = hh+':'+mm;
          const v  = raw[k];
          series.push((typeof v === 'number') ? v : null);
        }
      }
      const hasData = series.some(v => typeof v === 'number');
      drawLineChart(series, hasData);
    });
  }
  function drawLineChart(series, hasData){
    const Wc = chart.width, Hc = chart.height;
    chartCtx.clearRect(0,0,Wc,Hc);
    chartCtx.fillStyle = '#fff'; chartCtx.fillRect(0,0,Wc,Hc);
    chartCtx.strokeStyle='#ddd'; chartCtx.lineWidth=1;

    const left=40, right=8, top=8, bottom=22;
    const plotW = Wc-left-right, plotH=Hc-top-bottom;

    let maxY = 1;
    for (let i=0;i<series.length;i++){
      const v = series[i];
      if (typeof v === 'number' && v > maxY) maxY = v;
    }

    const steps=4;
    chartCtx.fillStyle='#666'; chartCtx.font='12px system-ui';
    for(let i=0;i<=steps;i++){
      const y = top + plotH*(1 - i/steps);
      chartCtx.beginPath(); chartCtx.moveTo(left,y); chartCtx.lineTo(left+plotW,y); chartCtx.stroke();
      const val = Math.round(maxY * i/steps);
      chartCtx.fillText(String(val), 6, y-2);
    }

    for(let h=0; h<=24; h+=6){
      const idx = Math.min(series.length-1, h*60);
      const x = left + plotW*(idx/(series.length-1));
      chartCtx.beginPath(); chartCtx.moveTo(x, top+plotH); chartCtx.lineTo(x, top+plotH+4); chartCtx.stroke();
      chartCtx.fillText(String(h)+'h', x-8, top+plotH+16);
    }

    if (!hasData){ chartNoData.style.display='flex'; return; } else { chartNoData.style.display='none'; }

    chartCtx.beginPath();
    chartCtx.strokeStyle='#111'; chartCtx.lineWidth=2;
    let inSeg = false;
    for(let k=0;k<series.length;k++){
      const v = series[k];
      const x = left + plotW*(k/(series.length-1));
      if (typeof v === 'number'){
        const y = top + plotH*(1 - (v/maxY));
        if (!inSeg){ chartCtx.moveTo(x,y); inSeg = true; } else { chartCtx.lineTo(x,y); }
      } else {
        inSeg = false;
      }
    }
    chartCtx.stroke();

    chartCtx.fillStyle = '#111';
    const r = 2.5;
    for(let k=0;k<series.length;k++){
      const v = series[k];
      if (typeof v === 'number'){
        const x = left + plotW*(k/(series.length-1));
        const y = top + plotH*(1 - (v/maxY));
        chartCtx.beginPath();
        chartCtx.arc(x, y, r, 0, Math.PI*2);
        chartCtx.fill();
      }
    }
  }

  dayPrev.addEventListener('click', ()=>{ selectedDay = new Date(selectedDay.getTime()-24*3600*1000); loadDayAndRender(); });
  dayNext.addEventListener('click', ()=>{ selectedDay = new Date(selectedDay.getTime()+24*3600*1000); loadDayAndRender(); });

  // ---------- Gestion (liste + actions) ----------
  const namesAll = {};          // uid -> pseudo
  const lastSeenByUid = {};     // uid -> ts (optionnel si tu l’enregistres côté client)
  const onlineSet = new Set();  // uids en ligne (presence)
  const bannedSet = new Set();  // uids bannis

  // presence
  db.ref('presence').on('child_added', s=>{ onlineSet.add(s.key); renderUsers(); });
  db.ref('presence').on('child_removed', s=>{ onlineSet.delete(s.key); renderUsers(); });

  // banned
  db.ref('banned').on('value', s=>{
    bannedSet.clear(); const v=s.val()||{};
    Object.keys(v).forEach(uid=>{ if (v[uid]) bannedSet.add(uid); });
    renderUsers();
  });

  // users (pseudos + lastSeen éventuel)
  db.ref('users').on('child_added', s=>{
    const uid=s.key, v=s.val()||{};
    if (v.name) namesAll[uid]=v.name; else delete namesAll[uid];
    if (typeof v.lastSeen==='number') lastSeenByUid[uid]=v.lastSeen;
    renderUsers();
  });
  db.ref('users').on('child_changed', s=>{
    const uid=s.key, v=s.val()||{};
    if (v.name) namesAll[uid]=v.name; else delete namesAll[uid];
    if (typeof v.lastSeen==='number') lastSeenByUid[uid]=v.lastSeen;
    renderUsers();
  });

  function fmtSeen(uid){
    const ts = lastSeenByUid[uid];
    if (ts) return fmtDateTime(ts);
    return onlineSet.has(uid) ? 'en ligne' : '—';
  }

  function matchesFilter(uid, name, q){
    if (!q) return true;
    q = q.toLowerCase();
    return (name && name.toLowerCase().includes(q)) || uid.toLowerCase().includes(q);
  }

  function renderUsers(){
    if (!usersBody) return;
    const q = (userSearch.value||'').trim();
    usersBody.innerHTML = '';
    const entries = Object.entries(namesAll)
      .filter(([uid,name])=> matchesFilter(uid, name, q))
      .sort((a,b)=> a[1].localeCompare(b[1], 'fr', { sensitivity:'base' }));

    const frag = document.createDocumentFragment();
    let count = 0;

    entries.forEach(([uid, name])=>{
      const tr=document.createElement('tr');

      const tdName=document.createElement('td'); tdName.textContent = name;
      const tdUid =document.createElement('td'); tdUid.innerHTML = '<span class="uid">'+uid+'</span>';
      const tdSeen=document.createElement('td'); tdSeen.textContent = fmtSeen(uid);
      const tdState=document.createElement('td');
      const badges = [];
      if (onlineSet.has(uid)) badges.push('<span class="badge online">En ligne</span>');
      if (bannedSet.has(uid)) badges.push('<span class="badge banned">Banni</span>');
      tdState.innerHTML = badges.join(' ');

      const tdAct=document.createElement('td');
      const actions=document.createElement('div'); actions.className='row-actions'; actions.style.visibility='hidden';

      const btnBan=document.createElement('button'); btnBan.className='danger'; btnBan.textContent='Bannir';
      btnBan.title='Bannir l’UID et effacer tous ses pixels';
      btnBan.addEventListener('click', (e)=>{ e.stopPropagation(); banUserFirebaseOnly(uid, name); });

      const btnErase=document.createElement('button'); btnErase.textContent='Effacer';
      btnErase.title='Supprimer le pseudo (le rendre disponible)';
      btnErase.addEventListener('click', (e)=>{ e.stopPropagation(); erasePseudo(uid, name); });

      actions.appendChild(btnBan); actions.appendChild(btnErase);
      tdAct.appendChild(actions);

      tr.append(tdName, tdUid, tdSeen, tdState, tdAct);

      tr.addEventListener('click', ()=>{
        const already = tr.classList.contains('sel');
        usersBody.querySelectorAll('tr').forEach(r=>{ r.classList.remove('sel'); r.querySelector('.row-actions').style.visibility='hidden'; });
        if (!already){ tr.classList.add('sel'); actions.style.visibility='visible'; }
      });

      frag.appendChild(tr); count++;
    });

    usersBody.appendChild(frag);
    usersCount.textContent = count + ' utilisateur(s)';
  }
  userSearch.addEventListener('input', renderUsers);

  async function erasePseudo(uid, name){
    if(!ADMIN_OK){ alert('Accès admin requis.'); return; }
    const ok = confirm('Effacer le pseudo de '+(name||uid)+' ?\nLe pseudo redeviendra disponible.');
    if (!ok) return;
    try{
      const snap = await db.ref('users/'+uid+'/name').once('value');
      const currentName = snap.val();
      if (currentName){
        const key = currentName.toLowerCase().replace(/[^a-z0-9_]/g,'');
        await db.ref('users_by_name/'+key).transaction(cur => (cur===uid) ? null : cur);
      }
      await db.ref('users/'+uid+'/name').remove();
      alert('Pseudo effacé.');
    }catch(e){ console.error(e); alert('Erreur pendant la suppression du pseudo.'); }
  }

  // ---- BAN (Firebase only : marque /banned + efface pixels de l’UID) ----
  async function banUserFirebaseOnly(uid, name){
    if(!ADMIN_OK){ alert('Accès admin requis.'); return; }
    const label = (name || uid);
    const ok = confirm(
      'Bannir définitivement ' + label + ' ?\n\n' +
      '• Marque /banned/{uid}=true\n' +
      '• Efface tous ses pixels (UID) dans la RTDB'
    );
    if (!ok) return;

    try{
      // 1) Marqueur UI
      await db.ref('banned/'+uid).set(true);

      // 2) Effacer pixels de cet UID (réécriture en blanc)
      const q = db.ref('pixels').orderByChild('author').equalTo(uid);
      const snap = await q.once('value');
      const updates = {};
      snap.forEach(child => {
        const k = child.key;
        updates['pixels/'+k] = { color: 1, author: null, ts: null }; // 1 = blanc
      });
      if (Object.keys(updates).length) await db.ref().update(updates);

      alert(`OK : ${label} banni et pixels effacés.`);
    } catch (e){
      console.error(e);
      alert('Erreur pendant le bannissement : ' + (e.message || e));
    }
  }

  // ---- RESET MOSAÏQUE (Firebase only) ----
  async function doMosaicResetFirebaseOnly(){
    // Efface pixels -> remet blanc ; purge history ; reset compteurs + marque lastReset
    // 1) Pixels -> blanc
    const pixSnap = await db.ref('pixels').once('value');
    const pix = pixSnap.val() || {};
    const upd1 = {};
    Object.keys(pix).forEach(k=>{
      upd1['pixels/'+k] = { color: 1, author: null, ts: null };
    });
    // 2) History -> remove complet
    const upd2 = { 'history': null };
    // 3) Compteurs + meta
    const upd3 = {
      'stats/clicksTotal': 0,
      'config/lastResetAt': firebase.database.ServerValue.TIMESTAMP
    };
    await db.ref().update(Object.assign({}, upd1, upd2, upd3));
  }

  // ---------- Init ----------
  loadBoardToPreview();
  initLeaderboard();

  document.querySelector('.tab[data-tab="stats"]').addEventListener('click', ()=>{
    if (!historyBody.children.length){
      const lim=parseInt(document.getElementById('histLimit').value,10)||200;
      loadHistory(lim);
    }
    loadDayAndRender();
  });
  document.getElementById('tab-gestion').addEventListener('click', ()=>{ renderUsers(); });
  </script>
</body>
</html>
